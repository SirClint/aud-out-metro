# Release workflow for aud-out-metro
# Triggered when a new release is created on GitHub
# Builds standalone executables for Windows, macOS, and Linux
# Uses PyInstaller to create platform-specific binaries

name: Build Release

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Application Version (e.g., 1.0.0)'
        required: true
        default: '0.1.0'

jobs:
  # Windows build job - creates .exe with PyInstaller
  build-windows:
    runs-on: windows-latest  # Uses Windows Server 2019
    steps:
    # Check out repository code
    - uses: actions/checkout@v3

    # Install Python 3.12 (required for audioop module)
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'  # Must match CI Python version

    # Install Python dependencies and PyInstaller
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    # Run PyInstaller via build_app.py
    # This creates a single-file Windows executable (.exe)
    - name: Build
      run: python build_app.py ${{ github.event.release.tag_name || github.event.inputs.version | replace('v', '') }}
    - name: Rename artifact
      run: |
        mv dist/aud-out-metro.exe dist/aud-out-metro-windows.exe
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: windows-build
        path: dist/aud-out-metro-windows.exe

  # macOS build job - creates Unix executable
  build-macos:
    runs-on: macos-latest  # Uses latest macOS runner

    steps:
    - uses: actions/checkout@v3

    # Install Python 3.12 for audioop support
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'  # Must match CI Python version

    # Install both Python and system dependencies
    # macOS needs PortAudio from Homebrew for PyAudio
    - name: Build
      run: python build_app.py ${{ github.event.release.tag_name || github.event.inputs.version | replace('v', '') }}
    - name: Rename artifact
      run: |
        mv dist/aud-out-metro dist/aud-out-metro-macos
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: macos-build
        path: dist/aud-out-metro-macos

  # Linux build job - creates Unix executable
  build-linux:
    runs-on: ubuntu-latest  # Uses Ubuntu runner

    steps:
    - uses: actions/checkout@v3

    # Install Python 3.12 for audioop support
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'  # Must match CI Python version

    # Install both system and Python dependencies
    # System packages needed for audio library compilation
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev portaudio19-dev libasound2-dev
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    - name: Build
      run: python build_app.py ${{ github.event.release.tag_name || github.event.inputs.version | replace('v', '') }}
    - name: Rename artifact
      run: |
        mv dist/aud-out-metro dist/aud-out-metro-linux
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: linux-build
        path: dist/aud-out-metro-linux

  # Final job - collects builds and attaches to release
  create-release:
    # Wait for all build jobs to complete
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest

    steps:
    # Download built executables from previous jobs
    - name: Download all artifacts
      uses: actions/download-artifact@v3  # Gets artifacts from build jobs

    # Generate checksums for security verification
    - name: Create SHA256SUMS
      run: |
        # Create checksum file containing hashes of all builds
        cd windows-build && sha256sum * > ../SHA256SUMS.txt && cd ..
        cd macos-build && sha256sum * >> ../SHA256SUMS.txt && cd ..
        cd linux-build && sha256sum * >> ../SHA256SUMS.txt && cd ..

    # Attach builds and checksums to the GitHub release
    - name: Upload to release
      uses: softprops/action-gh-release@v1  # Third-party action for release uploads
      with:
        files: |
          windows-build/*     # Windows .exe
          macos-build/*      # macOS binary
          linux-build/*      # Linux binary
          SHA256SUMS.txt     # Verification checksums